#!/bin/bash

# set -o xtrace
set -eu -o pipefail

_source="${BASH_SOURCE[0]}"
[ -z "${_source_dir:-}" ] && _source="${0}"
_source_dir="$( cd "$( dirname "${_source}" )" && cd .. && pwd )"

dumpEnvSecrets() {
  if [[ "${BUILDKITE_PLUGIN_AWS_PARAMSTORE_SECRETS_DUMP_ENV:-}" =~ ^(true|1)$ ]] ; then
    echo "~~~ Environment variables that were set" >&2;

    # shellcheck disable=SC2154 # var is defined as a global in hooks/environment
    comm -13 <(echo "$env_before") <(env | sort) || true
  fi
}

if [ -f "./custom-defaults" ] ; then
  # shellcheck disable=SC1091
  . "./custom-defaults"
fi

# shellcheck disable=SC2034
env_before="$(env | sort)"  # used by dumpEnvSecrets

envscript="$(BUILDKITE_PLUGIN_AWS_PARAMSTORE_SECRETS_DUMP_ENV=true python3 -m "${_source_dir}/environment")" # "${_source_dir}/environment/main.py")"
set -o allexport
# shellcheck disable=SC1090
source <( echo "$envscript" )
set +o allexport

dumpEnvSecrets

