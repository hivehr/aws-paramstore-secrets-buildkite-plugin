#!/bin/bash

#set -o xtrace
set -eu -o pipefail

_source="${BASH_SOURCE[0]}"
_source_dir="$( cd "$( dirname "${_source}" )" && cd .. && pwd )"

# shellcheck disable=SC1090
[ -f "${_source_dir}/custom-defaults" ] && source "${_source_dir}/custom-defaults"

[ -z "${BUILDKITE_PLUGIN_AWS_PARAMSTORE_SECRETS_DEFAULT_KEY:-}" ] && BUILDKITE_PLUGIN_AWS_PARAMSTORE_SECRETS_DEFAULT_KEY="global"
[ -z "${BUILDKITE_PLUGIN_AWS_PARAMSTORE_SECRETS_PATH:-}" ] && BUILDKITE_PLUGIN_AWS_PARAMSTORE_SECRETS_PATH="/vendors/buildkite/secrets"
[ -z "${BUILDKITE_PLUGIN_AWS_PARAMSTORE_SECRETS_KEY:-}" ] && BUILDKITE_PLUGIN_AWS_PARAMSTORE_SECRETS_KEY="BUILDKITE_PIPELINE_SLUG"

envscript="$(BUILDKITE_PLUGIN_AWS_PARAMSTORE_SECRETS_DEFAULT_KEY=${BUILDKITE_PLUGIN_AWS_PARAMSTORE_SECRETS_DEFAULT_KEY} \
  BUILDKITE_PLUGIN_AWS_PARAMSTORE_SECRETS_PATH=${BUILDKITE_PLUGIN_AWS_PARAMSTORE_SECRETS_PATH} \
  BUILDKITE_PLUGIN_AWS_PARAMSTORE_SECRETS_KEY=${BUILDKITE_PLUGIN_AWS_PARAMSTORE_SECRETS_KEY} \
  BUILDKITE_PLUGIN_AWS_PARAMSTORE_SECRETS_DUMP_ENV=true /usr/local/bin/bk-ssm-secrets)"

set -o allexport
eval "$envscript"
set +o allexport